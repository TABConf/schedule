<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TABConf Schedule</title>
    <style>
        :root {
            --bg: #0f1115;
            --surface: #11141a;
            --card: #171a21;
            --muted: #9aa3b2;
            --text: #e6e9ef;
            --accent: #4da3ff;
            --border: #2a2f3a;
            --col-gap: 10px;
            --row-gap: 2px;
            --px-per-min: 0.8;
        }

        html,
        body {
            overflow-x: auto;
            /* desktop layout preserved on mobile via horizontal scroll */
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 16px 48px;
            min-width: 900px;
            /* preserve 3-column layout; mobile can scroll horizontally */
        }

        h1 {
            margin: 0 0 12px 0;
            font-size: 24px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
        }

        select {
            background: #0d0f14;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 10px;
        }

        .days {
            margin-top: 18px;
        }

        .day {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 18px;
        }

        .day-h {
            padding: 14px;
            border-bottom: 1px solid var(--border);
            font-weight: 700;
            background: var(--surface);
            text-align: center;
            font-size: 28px;
        }

        .timeline {
            display: grid;
            grid-template-columns: 100px repeat(var(--cols), 1fr);
            gap: var(--row-gap) var(--col-gap);
            background: var(--surface);
            align-items: start;
            align-content: start;
            position: relative;
            padding-bottom: 20px;
        }

        .col-head {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 13px;
            padding: 6px 8px;
            text-align: center;
        }

        .col-head.time {
            text-align: left;
        }

        .time-label {
            font-size: 12px;
            color: var(--muted);
            align-self: start;
            padding-top: 4px;
        }

        .hour-line {
            grid-column: 1 / -1;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            height: 0;
        }

        .event {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: visible;
            align-self: stretch;
            height: 100%;
            box-sizing: border-box;
        }

        .event * {
            min-height: 0;
        }

        .event h4 {
            margin: 0 0 6px 0;
            font-size: 14px;
            line-height: 1.3;
        }

        .meta {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: auto;
        }

        .badge {
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.06);
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
        }

        a {
            color: var(--accent);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Day 0 compact styling */
        .day.day0 .event {
            padding: 8px;
        }

        .day.day0 .event h4 {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .day.day0 .meta {
            font-size: 11px;
            margin-bottom: 4px;
        }

        .day.day0 .badge {
            font-size: 10px;
            padding: 1px 5px;
        }

        /* ---------- Overlay for all-day / unscheduled (Days 1â€“4) ---------- */
        .overlay-col {
            position: relative;
            /* containing block for overlay stack */
            grid-column: 4;
            /* General column (time rail is col 1) */
            grid-row: 1 / -1;
            /* span header + all time rows */
            z-index: 10;
            /* above scheduled events */
            pointer-events: none;
            /* don't block grid scroll/clicks */
        }

        .overlay-stack {
            position: sticky;
            /* keeps stack under the header */
            top: 40px;
            /* adjust if your header row height changes */
            display: flex;
            flex-direction: column;
            gap: var(--row-gap);
            padding: 6px;
        }

        .event.overlay-card {
            pointer-events: auto;
            /* clickable cards */
            width: 100%;
            z-index: 11;
            /* above scheduled cards */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
        }

        .assignees {
            margin: 4px 0 6px;
            font-size: 12px;
            color: var(--muted);
        }

        .assignees strong {
            font-weight: 600;
            color: var(--text);
            /* normal text color for "With:" */
            opacity: 0.85;
        }

        .assignees .name {
            font-weight: 700;
            color: #ffd54f;
            /* warm bright yellow */
            opacity: 0.95;
        }



        /* Mobile zoom-out (keeps multi-column view) */
        @media(max-width:900px) {
            body {
                transform: scale(0.8);
                transform-origin: top left;
                width: 125%;
            }
        }

        @media(max-width:700px) {
            body {
                transform: scale(0.7);
                transform-origin: top left;
                width: 143%;
            }
        }

        @media(max-width:500px) {
            body {
                transform: scale(0.6);
                transform-origin: top left;
                width: 167%;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>TABConf Schedule</h1>
        <div class="controls">
            <label for="daySel">Day:</label>
            <select id="daySel">
                <option value="all">All</option>
                <option value="0">Day 0 - Oct 12</option>
                <option value="1">Day 1 - Oct 13</option>
                <option value="2">Day 2 - Oct 14</option>
                <option value="3">Day 3 - Oct 15</option>
                <option value="4">Day 4 - Oct 16</option>
            </select>
            <label for="typeSel">Type:</label>
            <select id="typeSel">
                <option value="all">All</option>
                <option>Workshop</option>
                <option>Talk</option>
                <option>Panel</option>
                <option>Debate</option>
                <option>Unrecorded</option>
                <option>Beginner</option>
                <option>Advanced</option>
                <option>Builder Days Project</option>
                <option>Satellite Event</option>
            </select>
            <span
                style="margin-left:auto; display:flex; align-items:center; gap:6px; font-size:13px; color:var(--text); opacity:0.85;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="15" height="15" fill="currentColor"
                    style="opacity:0.8;">
                    <path
                        d="M12 0C5.37 0 0 5.37 0 12a12 12 0 008.21 11.44c.6.11.82-.26.82-.58v-2.03c-3.34.73-4.04-1.61-4.04-1.61-.55-1.4-1.33-1.77-1.33-1.77-1.09-.74.09-.72.09-.72 1.21.09 1.84 1.25 1.84 1.25 1.07 1.83 2.8 1.3 3.49.99.11-.78.42-1.3.76-1.6-2.67-.3-5.47-1.34-5.47-5.95 0-1.32.47-2.4 1.24-3.25-.12-.3-.54-1.51.12-3.15 0 0 1.01-.32 3.3 1.23a11.4 11.4 0 016 0c2.29-1.55 3.3-1.23 3.3-1.23.66 1.64.24 2.85.12 3.15.77.85 1.24 1.93 1.24 3.25 0 4.63-2.81 5.64-5.49 5.94.43.37.81 1.1.81 2.22v3.29c0 .32.22.7.83.58A12.01 12.01 0 0024 12c0-6.63-5.37-12-12-12z" />
                </svg>
                <a href="https://github.com/orgs/TABConf/projects/9" target="_blank"
                    style="color:#ffd54f; font-weight:600; text-decoration:none; opacity:0.9;">
                    View the GitHub Project Source
                </a>
            </span>
        </div>
        <div id="days" class="days"></div>
    </div>

    <script>
        const norm = s => String(s || "").trim().toLowerCase();

        const parseAmPm = t => {
            if (!t) return NaN;
            const s = String(t).toUpperCase().replace(/\s+/g, '');
            const m = s.match(/^(\d{1,2})(?::(\d{2}))?(AM|PM)$/);
            if (!m) return NaN;
            let h = parseInt(m[1], 10);
            const min = m[2] ? parseInt(m[2], 10) : 0; const ap = m[3];
            if (ap === 'PM' && h < 12) h += 12; if (ap === 'AM' && h === 12) h = 0;
            return h * 60 + min;
        };

        const fmtHour = m => `${((Math.floor(m / 60) % 12) || 12)}:${(m % 60).toString().padStart(2, '0')} ${m < 720 ? 'AM' : 'PM'}`;

        function expandDays(dayStr) {
            const s = String(dayStr || "").toLowerCase();
            if (!s) return [];
            if (s.includes("all")) return [0, 1, 2, 3, 4];

            const nums = new Set();
            let m;

            // Ranges: "day 1-4", "days 2â€“3", "d 1â€”2"
            const rangeRe = /(day|days|d)\s*([0-4])\s*[-â€“â€”]\s*([0-4])/g;
            while ((m = rangeRe.exec(s))) {
                const a = parseInt(m[2], 10);
                const b = parseInt(m[3], 10);
                const start = Math.min(a, b);
                const end = Math.max(a, b);
                for (let i = start; i <= end; i++) nums.add(i);
            }

            // Singles
            const singleRe = /(day|days|d)\s*([0-4])/g;
            while ((m = singleRe.exec(s))) nums.add(parseInt(m[2], 10));

            return nums.size ? Array.from(nums).sort((a, b) => a - b) : [];
        }

        const mapVillageToCol = v => {
            const n = norm(v);
            if (n.includes('workshop room 1') || n.includes('bitdevs socratic village')) return 1;
            if (n.includes('workshop room 2') || n.includes('main stage')) return 2;
            return 3; // general
        };

        // Unique color generator based on label combo (card background/border)
        function djb2(str) { let h = 5381; for (let i = 0; i < str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i); return h >>> 0; }
        function colorFromLabels(labels) {
            const clean = (labels || []).map(l => norm(l?.name)).filter(Boolean);

            // Priority 1: Advanced
            const adv = (labels || []).find(l => /advanced/i.test(l.name) && l.color);
            if (adv) return { bg: adv.color + '20', br: adv.color };

            // Priority 2: Beginner
            const beg = (labels || []).find(l => /beginner/i.test(l.name) && l.color);
            if (beg) return { bg: beg.color + '20', br: beg.color };

            // Priority 3: Talk â†’ fixed light purple
            const talk = clean.includes('talk');
            if (talk) return { bg: 'hsla(270, 70%, 60%, 0.15)', br: 'hsl(270, 70%, 60%)' };

            // Fallback for unlabeled or other labels
            if (clean.length === 0) {
                return { bg: `hsla(210, 60%, 50%, 0.12)`, br: `hsl(210, 60%, 50%)` };
            }

            // Hash-based unique color for everything else
            const key = clean.sort().join('|');
            const hue = djb2(key) % 360;
            return { bg: `hsla(${hue}, 70%, 45%, 0.12)`, br: `hsl(${hue}, 70%, 45%)` };
        }

        // Safer hex parsing for label text contrast (supports #abc and #aabbcc)
        function hexToRGB(hex) {
            if (!hex) return [200, 200, 200];
            let h = hex.replace('#', '').trim();
            if (h.length === 3) h = h.split('').map(ch => ch + ch).join('');
            const r = parseInt(h.slice(0, 2), 16);
            const g = parseInt(h.slice(2, 4), 16);
            const b = parseInt(h.slice(4, 6), 16);
            return [r, g, b].map(v => (isNaN(v) ? 0 : v));
        }

        function getAssigneesText(assignees) {
            if (!assignees) return '';
            const arr = Array.isArray(assignees) ? assignees : [assignees];
            const names = arr
                .map(a => {
                    if (typeof a === 'string') return a.trim();
                    if (!a || typeof a !== 'object') return '';
                    return (a.name || a.handle || a.email || '').trim();
                })
                .filter(Boolean);
            return names.join(', ');
        }

        async function main() {
            const res = await fetch('data/schedule.json', { cache: 'no-store' });
            const all = await res.json();

            const mount = document.getElementById('days');
            const daySel = document.getElementById('daySel');
            const typeSel = document.getElementById('typeSel');

            // Auto-select day based on current date
            // const today = new Date();
            const today = new Date(2025, 9, 12);
            const month = today.getMonth() + 1; // 1â€“12
            const day = today.getDate();

            const dayMap = {
                13: '1',
                14: '2',
                15: '3',
                16: '4'
            };

            if (month === 10 && dayMap[day]) {
                daySel.value = dayMap[day];
            }

            function render() {
                mount.innerHTML = '';
                const dayFilter = daySel.value;
                const typeFilter = norm(typeSel.value);
                const pxPerMin = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--px-per-min'));

                for (let d = 0; d <= 4; d++) {
                    if (dayFilter !== 'all' && String(d) !== dayFilter) continue;

                    // Map then split into scheduled / unscheduled (no time means unscheduled)
                    const mapped = all
                        .filter(ev => expandDays(ev.day).includes(d))
                        .filter(ev => typeFilter === 'all' || (ev.labels || []).some(l => norm(l.name) === typeFilter))
                        .map(ev => ({ ...ev, _s: parseAmPm(ev.startTime), _e: parseAmPm(ev.endTime) }));

                    const scheduled = mapped.filter(ev => !isNaN(ev._s) && !isNaN(ev._e) && ev._e > ev._s);
                    const unscheduled = mapped.filter(ev => !(!isNaN(ev._s) && !isNaN(ev._e) && ev._e > ev._s));

                    if (scheduled.length === 0 && unscheduled.length === 0) continue;

                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'day';
                    const dayDates = ["October 12", "October 13", "October 14", "October 15", "October 16"];
                    dayDiv.innerHTML = `<div class="day-h">Day ${d} - ${dayDates[d] || ""}</div>`;

                    // --- Day 0 (single column, compact). Scheduled first, then unscheduled ---
                    if (d === 0) {
                        dayDiv.classList.add('day0');
                        const timeline = document.createElement('div');
                        timeline.className = 'timeline';
                        timeline.style.gridTemplateColumns = '1fr';
                        timeline.style.setProperty('--cols', 1);

                        const head = document.createElement('div');
                        head.className = 'col-head';
                        head.textContent = 'Offsite Pre Events';
                        head.style.gridColumn = '1';
                        timeline.appendChild(head);

                        const stack = [
                            ...scheduled.sort((a, b) => (a._s || 0) - (b._s || 0)),
                            ...unscheduled // show unscheduled after scheduled for Day 0
                        ];

                        stack.forEach(ev => {
                            const card = document.createElement('div');
                            card.className = 'event';
                            const { bg, br } = colorFromLabels(ev.labels || []);
                            card.style.background = bg; card.style.borderColor = br;
                            card.style.zIndex = isNaN(ev._s) || isNaN(ev._e) ? '1' : '2';

                            const h4 = document.createElement('h4');
                            const a = document.createElement('a');
                            a.href = ev.url || '#'; a.target = '_blank'; a.textContent = ev.title || 'Untitled';
                            h4.appendChild(a); card.appendChild(h4);

                            const meta = document.createElement('div');
                            meta.className = 'meta';
                            const timeText = 'General';
                            meta.textContent = `${timeText}${ev.village ? ' â€¢ ' + ev.village : ''}`;
                            card.appendChild(meta);

                            // --- Assignees (Day 0) ---
                            const people = getAssigneesText(ev.assignees);
                            if (people) {
                                const as = document.createElement('div');
                                as.className = 'assignees';
                                const names = people
                                    .split(',')
                                    .map(n => `<span class="name">${n.trim()}</span>`)
                                    .join(', ');
                                as.innerHTML = `<strong>With:</strong> ${names}`;
                                card.appendChild(as);
                            }

                            const labels = (ev.labels || []).filter(l => l.name && !['accepted', 'confirmed'].includes(norm(l.name)));
                            if (labels.length) {
                                const badges = document.createElement('div'); badges.className = 'badges';
                                labels.forEach(l => {
                                    const span = document.createElement('span'); span.className = 'badge'; span.textContent = l.name;
                                    if (l.color) {
                                        span.style.backgroundColor = l.color; span.style.borderColor = l.color;
                                        const [r, g, b] = hexToRGB(l.color);
                                        span.style.color = ((r * 299 + g * 587 + b * 114) / 1000) > 160 ? '#000' : '#fff';
                                    }
                                    badges.appendChild(span);
                                });
                                card.appendChild(badges);
                            }

                            timeline.appendChild(card);
                        });

                        dayDiv.appendChild(timeline);
                        mount.appendChild(dayDiv);
                        continue;
                    }

                    // --- Days 1â€“4 (time grid + overlay for unscheduled in General) ---
                    const timeline = document.createElement('div');
                    const numCols = 3;
                    timeline.className = 'timeline';
                    timeline.style.setProperty('--cols', numCols);

                    const colTitles = ["Time", "Workshop Room 1 / BitDevs", "Main Stage / Workshop Room 2", "General"];

                    // Header row
                    // If we have scheduled items, compute time rows; else keep only header
                    let minT = Infinity, maxT = -Infinity, totalMins = 0;
                    if (scheduled.length > 0) {
                        minT = Math.min(...scheduled.map(e => e._s));
                        maxT = Math.max(...scheduled.map(e => e._e));
                        totalMins = Math.max(0, maxT - minT);
                        const minuteRows = [];
                        for (let t = minT; t < maxT; t++) {
                            const hasEvent = scheduled.some(e => e._s <= t && e._e > t);
                            minuteRows.push(hasEvent ? `minmax(${pxPerMin}px,auto)` : `minmax(0.2px,auto)`);
                        }
                        timeline.style.gridTemplateRows = `auto ${minuteRows.join(' ')}`; timeline.style.gridTemplateRows = `auto ${minuteRows}`;
                    }

                    const rowOffset = 1; // header row index

                    // Header cells (row 1)
                    for (let i = 0; i <= numCols; i++) {
                        const head = document.createElement('div');
                        head.className = 'col-head' + (i === 0 ? ' time' : '');
                        head.textContent = colTitles[i] || '';
                        head.style.gridColumn = String(i + 1);
                        head.style.gridRow = '1';
                        timeline.appendChild(head);
                    }

                    // Hour lines + labels only if we have scheduled items
                    if (scheduled.length > 0) {
                        for (let t = Math.ceil(minT / 60) * 60; t < maxT; t += 60) {
                            const hourLine = document.createElement('div');
                            hourLine.className = 'hour-line';
                            hourLine.style.gridRow = String((t - minT + 1) + rowOffset);
                            timeline.appendChild(hourLine);

                            const label = document.createElement('div');
                            label.className = 'time-label';
                            label.textContent = fmtHour(t);
                            label.style.gridColumn = '1';
                            label.style.gridRow = String((t - minT + 1) + rowOffset);
                            timeline.appendChild(label);
                        }
                    }

                    // Scheduled events (time-based placement)
                    scheduled.forEach(ev => {
                        const col = mapVillageToCol(ev.village);
                        const card = document.createElement('div');
                        card.className = 'event';
                        card.style.gridColumn = String(col + 1);
                        const { bg, br } = colorFromLabels(ev.labels || []);
                        card.style.background = bg; card.style.borderColor = br;
                        card.style.zIndex = '2'; // below overlay but above base

                        const startRow = ev._s - minT + 1;
                        const endRow = ev._e - minT + 1;
                        card.style.gridRow = `${startRow + rowOffset} / ${endRow + rowOffset}`;

                        const h4 = document.createElement('h4');
                        const a = document.createElement('a');
                        a.href = ev.url || '#'; a.target = '_blank'; a.textContent = ev.title || 'Untitled';
                        h4.appendChild(a); card.appendChild(h4);

                        const meta = document.createElement('div');
                        meta.className = 'meta';
                        meta.textContent = `${ev.startTime} - ${ev.endTime}${ev.village ? ' â€¢ ' + ev.village : ''}`;
                        card.appendChild(meta);

                        // --- Assignees (scheduled) ---
                        const people = getAssigneesText(ev.assignees);
                        if (people) {
                            const as = document.createElement('div');
                            as.className = 'assignees';
                            const names = people
                                .split(',')
                                .map(n => `<span class="name">${n.trim()}</span>`)
                                .join(', ');
                            as.innerHTML = `<strong>With:</strong> ${names}`;
                            card.appendChild(as);
                        }

                        const labels = (ev.labels || []).filter(l => l.name && !['accepted', 'confirmed'].includes(norm(l.name)));
                        if (labels.length) {
                            const badges = document.createElement('div'); badges.className = 'badges';
                            labels.forEach(l => {
                                const span = document.createElement('span'); span.className = 'badge'; span.textContent = l.name;
                                if (l.color) {
                                    span.style.backgroundColor = l.color; span.style.borderColor = l.color;
                                    const [r, g, b] = hexToRGB(l.color);
                                    span.style.color = ((r * 299 + g * 587 + b * 114) / 1000) > 160 ? '#000' : '#fff';
                                }
                                badges.appendChild(span);
                            });
                            card.appendChild(badges);
                        }

                        timeline.appendChild(card);
                    });

                    // ---------- Overlay stack in the General column for all-day/unscheduled ----------
                    if (unscheduled.length > 0) {
                        const overlay = document.createElement('div');
                        overlay.className = 'overlay-col';
                        overlay.style.gridColumn = String(3 + 1);  // General col = 4
                        overlay.style.gridRow = '1 / -1';

                        const overlayStack = document.createElement('div');
                        overlayStack.className = 'overlay-stack';
                        overlay.appendChild(overlayStack);

                        // Optional header for the pile
                        const overlayHdr = document.createElement('div');
                        overlayHdr.className = 'col-head';
                        overlayHdr.textContent = 'General';
                        overlayHdr.style.textAlign = 'center';
                        overlayStack.appendChild(overlayHdr);

                        // Put unscheduled at the TOP (above scheduled), order as they appear
                        unscheduled.forEach(ev => {
                            const card = document.createElement('div');
                            card.className = 'event overlay-card';
                            const { bg, br } = colorFromLabels(ev.labels || []);
                            card.style.background = bg; card.style.borderColor = br;

                            const h4 = document.createElement('h4');
                            const a = document.createElement('a');
                            a.href = ev.url || '#'; a.target = '_blank'; a.textContent = ev.title || 'Untitled';
                            h4.appendChild(a); card.appendChild(h4);

                            const meta = document.createElement('div');
                            meta.className = 'meta';
                            const village = ev.village ? ' â€¢ ' + ev.village : '';
                            meta.textContent = `${village}`;
                            card.appendChild(meta);

                            // --- Assignees (unscheduled/overlay) ---
                            const people = getAssigneesText(ev.assignees);
                            if (people) {
                                const as = document.createElement('div');
                                as.className = 'assignees';
                                const names = people
                                    .split(',')
                                    .map(n => `<span class="name">${n.trim()}</span>`)
                                    .join(', ');
                                as.innerHTML = `<strong>With:</strong> ${names}`;
                                card.appendChild(as);
                            }

                            const labels = (ev.labels || []).filter(l => l.name && !['accepted', 'confirmed'].includes(norm(l.name)));
                            if (labels.length) {
                                const badges = document.createElement('div'); badges.className = 'badges';
                                labels.forEach(l => {
                                    const span = document.createElement('span'); span.className = 'badge'; span.textContent = l.name;
                                    if (l.color) {
                                        span.style.backgroundColor = l.color; span.style.borderColor = l.color;
                                        const [r, g, b] = hexToRGB(l.color);
                                        span.style.color = ((r * 299 + g * 587 + b * 114) / 1000) > 160 ? '#000' : '#fff';
                                    }
                                    badges.appendChild(span);
                                });
                                card.appendChild(badges);
                            }

                            overlayStack.appendChild(card);
                        });

                        // Add overlay last so it paints above the grid
                        timeline.appendChild(overlay);
                    }

                    dayDiv.appendChild(timeline);
                    mount.appendChild(dayDiv);
                }
            }

            daySel.addEventListener('change', render);
            typeSel.addEventListener('change', render);
            render();
        }

        main();

    </script>
</body>

</html>
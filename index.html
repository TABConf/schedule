<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>TABConf Schedule</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #121212;
            color: #eaeaea;
            padding: 40px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #1e1e1e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        th,
        td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #333;
            vertical-align: top;
        }

        td:nth-child(3) {
            white-space: nowrap;
            min-width: 140px;
        }

        th {
            background-color: #242424;
            cursor: pointer;
            position: relative;
        }

        th:hover {
            background-color: #333;
        }

        th.sort-asc::after {
            content: " ▲";
        }

        th.sort-desc::after {
            content: " ▼";
        }

        tr:hover {
            background-color: #2a2a2a;
        }

        a {
            color: #00d4ff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .label {
            display: inline-block;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 2em;
            margin-right: 5px;
            color: #fff;
            background-color: #444;
            border: 1px solid transparent;
            filter: brightness(1.2);
        }


        .table-wrapper {
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>TABConf 6 Schedule</h1>
    <div class="table-wrapper">
        <table id="schedule">
            <thead>
                <tr>
                    <th data-key="title">Title</th>
                    <th data-key="day">Day</th>
                    <th data-key="time">Time</th>
                    <th data-key="village">Village</th>
                    <th data-key="assignees">Assignees</th>
                    <th data-key="labels">Labels</th>
                    <th data-key="summary">Summary</th>
                    <th>Link</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let sortKey = '';
        let sortAsc = true;

        function parseTimeRange(range) {
            const time = range.split(' - ')[0];
            const [raw, period] = time.split(' ');
            if (!raw || !period) return 0;

            let [h, m] = raw.split(':').map(Number);
            if (period.toUpperCase() === 'PM' && h !== 12) h += 12;
            if (period.toUpperCase() === 'AM' && h === 12) h = 0;
            return h * 60 + (m || 0);
        }

        function renderTable(data) {
            const tbody = document.querySelector('#schedule tbody');
            tbody.innerHTML = '';

            data.forEach(i => {
                const assignees = i.assignees
                    ? i.assignees.split(', ').map(a => `<a href="https://github.com/${a}" target="_blank">@${a}</a>`).join(', ')
                    : '';

                const labels = i.labels?.map(l => {
                    const bg = l.color;
                    return `<span class="label" style="
                background-color: ${shadeColor(bg, -20)};
                color: ${bg};
                border: 1px solid ${bg};
              ">${l.name}</span>`;
                }).join('') || '';

                const row = `<tr>
              <td>${i.title}</td>
              <td>${i.day}</td>
              <td>${i.time}</td>
              <td>${i.village}</td>
              <td>${assignees}</td>
              <td>${labels}</td>
              <td>${i.summary}</td>
              <td><a href="${i.url}" target="_blank">View</a></td>
            </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function shadeColor(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            let r = (num >> 16) + percent;
            let g = ((num >> 8) & 0x00FF) + percent;
            let b = (num & 0x0000FF) + percent;

            r = Math.max(Math.min(255, r), 0);
            g = Math.max(Math.min(255, g), 0);
            b = Math.max(Math.min(255, b), 0);

            return `rgb(${r}, ${g}, ${b})`;
        }

        function sortData(data, key) {
            return [...data].sort((a, b) => {
                if (key === 'time') {
                    return sortAsc
                        ? parseTimeRange(a.time) - parseTimeRange(b.time)
                        : parseTimeRange(b.time) - parseTimeRange(a.time);
                }
                const valA = (a[key] || '').toLowerCase();
                const valB = (b[key] || '').toLowerCase();
                return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
            });
        }

        fetch('data/schedule.json')
            .then(res => res.json())
            .then(data => {
                // default sort by day then time
                const sorted = [...data].sort((a, b) => {
                    const dA = a.day?.toLowerCase() || '';
                    const dB = b.day?.toLowerCase() || '';
                    if (dA === dB) {
                        return parseTimeRange(a.time) - parseTimeRange(b.time);
                    }
                    return dA.localeCompare(dB);
                });

                renderTable(sorted);
                sortKey = 'day';
                sortAsc = true;
                document.querySelectorAll('th').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                    if (th.dataset.key === 'day') {
                        th.classList.add('sort-asc');
                    }
                });

                document.querySelectorAll('th[data-key]').forEach(th => {
                    th.addEventListener('click', () => {
                        const key = th.dataset.key;
                        if (sortKey === key) sortAsc = !sortAsc;
                        else {
                            sortKey = key;
                            sortAsc = true;
                        }

                        document.querySelectorAll('th').forEach(th =>
                            th.classList.remove('sort-asc', 'sort-desc')
                        );
                        th.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');

                        const sortedNew = sortData(data, key);
                        renderTable(sortedNew);
                    });
                });
            });
    </script>

</body>

</html>